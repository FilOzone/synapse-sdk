name: Sync Contract Addresses

on:
  pull_request:
    branches:
      - master
  workflow_dispatch:
  schedule:
    # Run daily at 00:00 UTC to catch upstream changes
    - cron: "0 0 * * *"

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Use Node.js lts/*
        uses: actions/setup-node@v6
        with:
          node-version: lts/*

      - name: Sync Contract Addresses
        run: node docs/scripts/sync-contract-addresses.ts

      - name: Check for changes
        id: git-check
        run: |
          if [ -n "$(git status --porcelain docs/src/content/docs/resources/contracts.md)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "::warning::Contract addresses are out of date"
            git diff docs/src/content/docs/resources/contracts.md
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      # On PRs: Fail if docs are out of date (contributor must update)
      - name: Fail if docs are out of date
        if: steps.git-check.outputs.changes == 'true' && github.event_name == 'pull_request'
        run: |
          echo "::error::Contract addresses in docs are out of date. Run 'node docs/scripts/sync-contract-addresses.ts' and commit the changes."
          exit 1

      # On schedule/manual: Auto-create PR with updates
      - name: Create Pull Request
        if: steps.git-check.outputs.changes == 'true' && github.event_name != 'pull_request'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "docs: sync contract addresses"
          title: "docs: sync contract addresses"
          body: |
            This PR updates the contract addresses in the documentation to match the latest values from [FilOzone/filecoin-services deployments.json](https://github.com/FilOzone/filecoin-services/blob/main/service_contracts/deployments.json).

            Auto-generated by the sync-contract-addresses workflow.
          branch: sync-contract-addresses
          delete-branch: true
          labels: documentation
