<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDP Tool Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        textarea {
            height: 80px;
            resize: vertical;
        }
        button {
            background-color: #007cba;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #005a8b;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .network-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .network-option {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        .network-option.selected {
            border-color: #007cba;
            background-color: #e7f3ff;
        }
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PDP Tool Test Interface</h1>
        
        <div class="form-group">
            <label>Network:</label>
            <div class="network-selector">
                <div class="network-option selected" data-network="calibration">
                    <strong>Calibration Testnet</strong><br>
                    <small>Chain ID: 314159</small>
                </div>
                <div class="network-option" data-network="mainnet">
                    <strong>Mainnet</strong><br>
                    <small>Chain ID: 314</small>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Wallet Connection:</label>
            <button id="connectWalletBtn">Connect MetaMask</button>
            <div id="walletStatus" class="help-text">Click to connect your MetaMask wallet for signing</div>
        </div>

        <div class="form-group">
            <label for="pdpEndpoint">PDP Endpoint:</label>
            <input type="text" id="pdpEndpoint" value="http://192.168.1.5:4702" />
            <div class="help-text">The URL of the PDP server to send the request to</div>
        </div>

        <div class="form-group">
            <label for="recordKeeper">Record Keeper Contract:</label>
            <input type="text" id="recordKeeper" value="0xD2669f81d5Af503a8C86b9FBF9b80d4572c13c04" />
            <div class="help-text">Address of the SimplePDPServiceWithPayments contract</div>
        </div>

        <div class="form-group">
            <label for="payee">Storage Provider Address:</label>
            <input type="text" id="payee" value="0x78bF4d833fC2ba1Abd42Bc772edbC788EC76A28F" />
            <div class="help-text">Address of the storage provider that will receive payments</div>
        </div>

        <div class="form-group">
            <label for="clientDataSetId">Client Dataset ID:</label>
            <input type="number" id="clientDataSetId" value="0" />
            <div class="help-text">Unique identifier for your dataset (usually 0 for first dataset)</div>
        </div>

        <div class="form-group">
            <label for="withCDN">Enable CDN:</label>
            <select id="withCDN">
                <option value="false">No</option>
                <option value="true">Yes</option>
            </select>
            <div class="help-text">Whether to enable CDN services for faster retrieval</div>
        </div>

        <div class="form-group">
            <button id="createProofSetBtn">Create Proof Set</button>
            <button id="checkStatusBtn" disabled>Check Status</button>
        </div>

        <div id="status" class="status info" style="display: none;"></div>
    </div>

    <!-- Load ethers from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
    
    <!-- Load Synapse SDK browser bundle -->
    <script src="dist/browser/synapse-sdk.min.js"></script>

    <script>
        // The SDK is now available as window.SynapseSDK
        const { PDPAuthHelper, PDPTool } = window.SynapseSDK;
        
        // Contract addresses for different networks
        const CONTRACT_ADDRESSES = {
            mainnet: {
                pdpService: '0x1234567890123456789012345678901234567890' // Replace with actual mainnet address
            },
            calibration: {
                pdpService: '0xD2669f81d5Af503a8C86b9FBF9b80d4572c13c04' // Your deployed contract
            }
        }

        let currentNetwork = 'calibration'
        let currentTxHash = null
        let connectedSigner = null
        let connectedAddress = null

        // Network selection
        document.querySelectorAll('.network-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.network-option').forEach(o => o.classList.remove('selected'))
                option.classList.add('selected')
                currentNetwork = option.dataset.network
                updateContractAddress()
            })
        })

        function updateContractAddress() {
            const recordKeeperInput = document.getElementById('recordKeeper')
            recordKeeperInput.value = CONTRACT_ADDRESSES[currentNetwork].pdpService
        }

        // MetaMask connection functionality
        async function connectMetaMask() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('MetaMask is not installed. Please install MetaMask browser extension.')
                }

                showStatus('Connecting to MetaMask...', 'info')
                
                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' })
                
                if (accounts.length === 0) {
                    throw new Error('No accounts found. Please unlock MetaMask.')
                }

                // Create ethers provider and signer
                const provider = new ethers.BrowserProvider(window.ethereum)
                connectedSigner = await provider.getSigner()
                connectedAddress = accounts[0]

                // Check network
                const network = await provider.getNetwork()
                const expectedChainId = currentNetwork === 'mainnet' ? 314 : 314159
                
                if (Number(network.chainId) !== expectedChainId) {
                    showStatus(`Wrong network! Please switch to ${currentNetwork === 'mainnet' ? 'Filecoin Mainnet' : 'Calibration Testnet'} (Chain ID: ${expectedChainId})`, 'error')
                    return
                }

                // Update UI
                document.getElementById('connectWalletBtn').textContent = 'Connected'
                document.getElementById('connectWalletBtn').disabled = true
                document.getElementById('walletStatus').textContent = `Connected: ${connectedAddress.slice(0, 6)}...${connectedAddress.slice(-4)} on ${currentNetwork === 'mainnet' ? 'Mainnet' : 'Calibration'}`
                document.getElementById('createProofSetBtn').disabled = false

                showStatus(`Successfully connected to MetaMask!
Address: ${connectedAddress}
Network: ${currentNetwork === 'mainnet' ? 'Filecoin Mainnet' : 'Calibration Testnet'} (${network.chainId})`, 'success')

            } catch (error) {
                console.error('MetaMask connection error:', error)
                showStatus(`Failed to connect to MetaMask: ${error.message}`, 'error')
                
                // Reset connection state
                connectedSigner = null
                connectedAddress = null
                document.getElementById('connectWalletBtn').textContent = 'Connect MetaMask'
                document.getElementById('connectWalletBtn').disabled = false
                document.getElementById('walletStatus').textContent = 'Click to connect your MetaMask wallet for signing'
                document.getElementById('createProofSetBtn').disabled = true
            }
        }

        // Network change handler
        if (window.ethereum) {
            window.ethereum.on('chainChanged', () => {
                // Reload page on network change to reset connection
                window.location.reload()
            })

            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    // User disconnected
                    connectedSigner = null
                    connectedAddress = null
                    document.getElementById('connectWalletBtn').textContent = 'Connect MetaMask'
                    document.getElementById('connectWalletBtn').disabled = false
                    document.getElementById('walletStatus').textContent = 'Click to connect your MetaMask wallet for signing'
                    document.getElementById('createProofSetBtn').disabled = true
                    showStatus('MetaMask disconnected', 'info')
                } else {
                    // Account changed, reconnect
                    connectMetaMask()
                }
            })
        }

        document.getElementById('connectWalletBtn').addEventListener('click', connectMetaMask)

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status')
            statusDiv.textContent = message
            statusDiv.className = `status ${type}`
            statusDiv.style.display = 'block'
        }

        function validateInputs() {
            const pdpEndpoint = document.getElementById('pdpEndpoint').value
            const recordKeeper = document.getElementById('recordKeeper').value
            const payee = document.getElementById('payee').value

            if (!connectedSigner) {
                throw new Error('Please connect your MetaMask wallet first')
            }

            if (!pdpEndpoint || !pdpEndpoint.startsWith('http')) {
                throw new Error('Please enter a valid PDP endpoint URL')
            }

            if (!recordKeeper || !ethers.isAddress(recordKeeper)) {
                throw new Error('Please enter a valid record keeper contract address')
            }

            if (!payee || !ethers.isAddress(payee)) {
                throw new Error('Please enter a valid storage provider address')
            }

            return { pdpEndpoint, recordKeeper, payee }
        }

        document.getElementById('createProofSetBtn').addEventListener('click', async () => {
            try {
                showStatus('Validating inputs...', 'info')
                
                const { pdpEndpoint, recordKeeper, payee } = validateInputs()
                const clientDataSetId = parseInt(document.getElementById('clientDataSetId').value)
                const withCDN = document.getElementById('withCDN').value === 'true'
                
                console.log('Creating proof set with:', {
                    clientDataSetId,
                    withCDN,
                    payee,
                    recordKeeper
                })

                showStatus('Creating PDP auth helper and tool...', 'info')
                
                // Create auth helper and PDP tool using connected MetaMask signer
                const chainId = currentNetwork === 'mainnet' ? 314 : 314159
                const authHelper = new PDPAuthHelper(recordKeeper, connectedSigner, chainId)
                const pdpTool = new PDPTool(pdpEndpoint, authHelper)

                showStatus('Signing and sending proof set creation...', 'info')

                // Create proof set using the SDK's PDPTool
                const result = await pdpTool.createProofSet(clientDataSetId, payee, withCDN, recordKeeper)
                
                currentTxHash = result.txHash
                document.getElementById('checkStatusBtn').disabled = false
                
                showStatus(`Proof set creation submitted successfully!
Transaction Hash: ${result.txHash}
Status URL: ${result.statusUrl}

You can now check the status to see when it's confirmed on-chain.`, 'success')

            } catch (error) {
                console.error('Error creating proof set:', error)
                showStatus(`Error: ${error.message}`, 'error')
            }
        })

        document.getElementById('checkStatusBtn').addEventListener('click', async () => {
            if (!currentTxHash) {
                showStatus('No transaction hash available. Create a proof set first.', 'error')
                return
            }

            try {
                showStatus('Checking proof set creation status...', 'info')
                
                const { pdpEndpoint } = validateInputs()
                
                // We don't need the full auth setup just to check status
                const dummyWallet = ethers.Wallet.createRandom()
                const authHelper = new PDPAuthHelper('0x0000000000000000000000000000000000000000', dummyWallet, 314159)
                const pdpTool = new PDPTool(pdpEndpoint, authHelper)

                const status = await pdpTool.getProofSetCreationStatus(currentTxHash)
                
                const statusMessage = `Proof Set Creation Status:
Transaction Hash: ${status.createMessageHash}
Transaction Status: ${status.txStatus}
Proof Set Created: ${status.proofsetCreated}
Success: ${status.ok === null ? 'Pending' : status.ok}
Service: ${status.service}
${status.proofSetId ? `Proof Set ID: ${status.proofSetId}` : ''}`

                const statusType = status.ok === false ? 'error' : status.proofsetCreated ? 'success' : 'info'
                showStatus(statusMessage, statusType)

            } catch (error) {
                console.error('Error checking status:', error)
                showStatus(`Error checking status: ${error.message}`, 'error')
            }
        })

        // Initial message
        showStatus('Enter your details above and click "Create Proof Set" to begin.', 'info')
    </script>
</body>
</html>